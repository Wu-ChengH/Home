<h2 class="contentTitle">数据表</h2>
<ul class="contentURL">
	<li>
		<i class="icon iconfont icon-shouye-shouye" style="font-size: 12px"></i>
		<a href="#">首页</a>
	</li>
	<li>
		<i class="icon iconfont icon-bbgxiayiji"></i>
		<a href="#">表单</a>
	</li>
	<li>
		<i class="icon iconfont icon-bbgxiayiji"></i>
		数据表
	</li>
</ul>
<div class="map" style="width: 60%;height: 600px;z-index: 2;float: left;"></div>
<div class="map-tab">
	<h2>成都市<span class="city-name"></span>人口信息</h2>
	<div class="population">
        <div class="populNum">
            <h3>总人口</h3>
            <p class="sum"></p>
        </div>  
        <div class="populNum">
            <h3>男性人口</h3>
            <p class="man"></p>
        </div>
        <div class="populNum">
            <h3>女性人口</h3>
            <p class="woman"></p>
        </div>
    </div>
</div>
<div class="pie"></div>
<script>
	define(function(require){
		require("src/webapps/details/charts/chengdu.js");
		var base = require("Base");
		return base.extend({
			onInit : function(option){
				var _this = this;
				_this.myChart = echarts.init(_this.$('.map')[0]);
                _this.myPie = echarts.init(_this.$('.pie')[0]);
				this.jiaZ();
				this.otherFunc();
                this.popul();
                this.onMenuChange();
			},
			onMenuChange : function(){
				var _this = this;
				$(".menuChange").on("change",function(){
					var _name = {};
					_name.name = $(".city-name").text();
					_this.jiaZ(_name);
				})
			},
			otherFunc : function(){
				var _this = this;
				this.myChart.on('click', function (params) {
				    _this.jiaZ(params);
                    _this.popul(params);
				});
			},
			jiaZ : function(params){
				var color = '#a6c84c';
				var series = [];
				var _name = '锦江区';
				var planePath = 'none';
				if (params) {
					_name = params.name;
					series.splice(1,(series.length-1));
				}

				var geoCoordMap = {
					"xx": [105.15, 31.2],
					"yy": [105.15, 30.8],
				    '锦江区': [104.080989, 30.657689],
				    '武侯区': [104.05167, 30.630862],
				    '青羊区': [104.055731, 30.667648],
				    '龙泉驿区': [104.269181, 30.56065],
				    '成华区': [104.103077, 30.660275],
				    '金牛区': [104.043487, 30.692058],
				    '青白江区': [104.25494, 30.883438],
				    '温江区': [103.836776, 30.697996],
				    '新都区': [104.16022, 30.824223],
				    '郫都区': [103.887842, 30.808752],
				    '双流区': [103.922706, 30.573243],
				    '金堂县': [104.415604, 30.858417],
				    '大邑县': [103.522397, 30.586602],
				    '蒲江县': [103.511541, 30.194359],
				    '新津县': [103.812449, 30.414284],
				    '都江堰市': [103.627898, 30.99114],
				    '简阳市': [104.550339, 30.390666],
				    '彭州市': [103.941173, 30.985161],
				    '崇州市': [103.671049, 30.631478],
				    '邛崃市': [103.46143, 30.413271]
				};

				var BJData = [
				    [{name:_name}, {name:'xx',value:95}],
				    [{name:_name}, {name:'yy',value:90}]
				];
				var item = [_name, BJData];
			    series.push({
			        name: item[0],
			        type: 'lines',
			        zlevel: 1,
			        effect: {
			            show: true,
			            period: 3,
			            trailLength: 0.7,
			            color: 'red',
			            symbolSize: 3
			        },
			        lineStyle: {
			            normal: {
			                color: color,
			                width: 0,
			                curveness: 0.2
			            }
			        },
			        data: convertData(item[1])
			    },
			    {
			        name: item[0],
			        type: 'effectScatter',
			        coordinateSystem: 'geo',
			        zlevel: 2,
			        rippleEffect: {
			            brushType: 'stroke'
			        },
			        label: {
			            normal: {
			                show: true,
			                position: 'right',
			                formatter: '{b}'
			            }
			        },
			        symbolSize: function (val) {
			            return val[2] / 8;
			        },
			        itemStyle: {
			            normal: {
			                color: color
			            }
			        },
			        data: [{
			                name: item[0],
			                value: geoCoordMap[item[0]].concat(90)
			            }]
			    });

			    var option = {
			        title : {
			            text: '成都',
			            subtext: '数据纯属虚构',
			            left: 'center',
			            textStyle : {
			                color: '#999'
			            }
			        },
			        tooltip : {
			            trigger: 'item'
			        },
			        legend: {
			            orient: 'vertical',
			            top: 'bottom',
			            left: 'right',
			            data:[],
			            textStyle: {
			                color: 'blue'
			            },
			            selectedMode: 'single'
			        },
			        geo: {
			            map: 'chengdu',
			            label: {
			                emphasis: {
			                    show: false
			                }
			            },
			            roam: true,
			            itemStyle: {
			                normal: {
			                    areaColor: '#36c6d3',
			                    borderColor: '#ed6b75'
			                },
			                emphasis: {
			                    areaColor: '#5C9ACF'
			                }
			            },
			            scaleLimit: {
			            	max: 1,
			            	min: 1
			            }
			        },
			        series: series
			    };
			    this.myChart.setOption(option);

			    function convertData(data) {
			        var res = [];
			        for (var i = 0; i < data.length; i++) {
			            var dataItem = data[i];
			            var fromCoord = geoCoordMap[dataItem[0].name];
			            var toCoord = geoCoordMap[dataItem[1].name];
			            if (fromCoord && toCoord) {
			                res.push({
			                    fromName: dataItem[0].name,
			                    toName: dataItem[1].name,
			                    coords: [fromCoord, toCoord]
			                });
			            }
			        }
			        return res;
			    }
			},
            popul: function(params){
                var _name = "锦江区";
                if (params) {
                    _name = params.name;
                }

                var population = {
                    "锦江区":{
                        sum:828140,
                        man:528140,
                        woman:300000
                    },
                    "龙泉驿区":{
                        sum:685422,
                        man:365422,
                        woman:320000
                    },
                    "武侯区":{
                        sum:1375699,
                        man:1000000,
                        woman:375699
                    },
                    "青羊区":{
                        sum:938785,
                        man:600000,
                        woman:338785
                    },
                    "成华区":{
                        sum:690422,
                        man:490422,
                        woman:200000
                    },
                    "金牛区":{
                        sum:767203,
                        man:300000,
                        woman:467203
                    },
                    "青白江区":{
                        sum:1200776,
                        man:750000,
                        woman:650776
                    },
                    "温江区":{
                        sum:381792,
                        man:200000,
                        woman:181792
                    },
                    "新都区":{
                        sum:775703,
                        man:47000,
                        woman:305703
                    },
                    "郫都区":{
                        sum:457070,
                        man:250070,
                        woman:207000
                    },
                    "双流区":{
                        sum:896162,
                        man:406162,
                        woman:500000
                    },
                    "金堂县":{
                        sum:1279930,
                        man:679930,
                        woman:600000
                    },
                    "大邑县":{
                        sum:717227,
                        man:417277,
                        woman:300000
                    },
                    "蒲江县":{
                        sum:502199,
                        man:302199,
                        woman:200000
                    },
                    "新津县":{
                        sum:302199,
                        man:202199,
                        woman:100000
                    },
                    "都江堰市":{ 
                        sum:456548,
                        man:256548,
                        woman:200000
                    },
                    "简阳市":{ 
                        sum:239562,
                        man:139562,
                        woman:100000
                    },
                    "彭州市":{ 
                        sum:657996,
                        man:357996,
                        woman:300000
                    },
                    "崇州市":{ 
                        sum:762887,
                        man:462887,
                        woman:300000
                    },
                    "邛崃市":{ 
                        sum:612753,
                        man:312753,
                        woman:300000
                    }
                }

                $(".city-name").text(_name);
                $(".sum").text(population[_name].sum);
                $(".man").text(population[_name].man);
                $(".woman").text(population[_name].woman);
                
                var regionalPopulation = {
                    title : {
                        text: _name+"男女比例",
                        subtext: '纯属虚构',
                        x:'center'
                    },
                    tooltip : {
                        trigger: 'item',
                        formatter: "{a} <br/>{b} : {c} ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        data: ['男','女']
                    },
                    series : [
                        {
                            name: '男女比例',
                            type: 'pie',
                            radius : '55%',
                            center: ['50%', '60%'],
                            color:["blue","red"],
                            data:[
                                {value:population[_name].man, name:'男'},
                                {value:population[_name].woman, name:'女'}
                            ],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };

                this.myPie.setOption(regionalPopulation);
            }
		});
	});
</script>